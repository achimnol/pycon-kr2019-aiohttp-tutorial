<!doctype html>
<html>
<head>
  <title>My Chat</title>
  <style type="text/css">
  body {
    margin: 0;
    padding: 0;
  }
  #chat {
    position: absolute;
    width: calc(100% - 10px);
    top: 50px;
    bottom: 30px;
    margin: 0;
    padding: 5px;
    overflow-y: scroll;
    background: #f2f2f2;
  }
  #chat .user {
    display: inline-block;
    width: calc(20% - 4px);
    padding: 2px;
    margin: 0;
    font-weight: bold;
  }
  #chat .text {
    display: inline-block;
    width: calc(80% - 4px);
    padding: 2px;
    margin: 0;
  }
  #chatInput {
    position: fixed;
    bottom: 0;
    width: calc(100% - 10px);
    height: 30px;
    margin: 0;
    padding: 5px;
    background: #ccc;
  }
  #msg {
    width: calc(100% - 100px);
    height: 20px;
  }
  #send {
    width: 70px;
    height: 20px;
    margin: 0;
  }
  </style>
</head>
<body>
  <p>User: {{ user_id }}</p>
  <div id="chat"></div>
  <div id="chatInput">
    <input type="text" id="msg">
    <button id="send">Send</button>
  </div>

<script type="text/javascript">

async function sendChat(msg) {
  let rqstData = {
    'text': msg,
  };
  console.log('sendChat', rqstData);
  let resp = await fetch('/chat', {method: 'POST', body: JSON.stringify(rqstData)});
  let result = await resp.json();
  return result;
}

document.addEventListener('DOMContentLoaded', (e) => {
  let send_button = document.getElementById('send');
  let chat_input = document.getElementById('msg');
  send_button.addEventListener('click', (e) => {
    sendChat(chat_input.value).then((result) => {
      console.log('sendChat success:', result);
      chat_input.value = '';
    }).catch((err) => {
      console.log('sendChat error:', err);
    });
  });
  chat_input.addEventListener('keyup', (e) => {
    if (e.keyCode == 13) {
      e.preventDefault();
      if (chat_input.value == '')
        return;
      send_button.click();
    }
  });

  let evt_source = new EventSource("/chat");
  evt_source.onmessage = (e) => {
    console.log('chat receieved', e);
    let msg_elem = document.createElement('div');
    msg_elem.classList.add('message');
    msg_elem.insertAdjacentHTML('beforeend', '<span class="user"></span>');
    msg_elem.insertAdjacentHTML('beforeend', '<span class="text"></span>');
    msg_elem.querySelector('.user').innerText = JSON.parse(e.data).user;
    msg_elem.querySelector('.text').innerText = JSON.parse(e.data).text;
    document.getElementById('chat').appendChild(msg_elem);
  };
});

</script>
</body>
</html>
